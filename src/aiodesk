#!/usr/bin/env bash
#
# Set-up everything that is needed for the AiO desktop.
#

desktops=6

shell=bash

fontwidth=7
fontheight=14

smallterm=80
bigterm=160
termheight=50
borderwidth=1
yoffset=14
pagerwidth=64

rxvt="rxvt -fn ${fontwidth}x${fontheight} -fb ${fontwidth}x${fontheight}"

#
# For all connected screens set-up the same layout if possible.
#
IFS="
"

for screen in $(xrandr -q | grep -e '^Screen'); do
    screennumber=$(echo $screen | cut -d' ' -f2 | cut -d':' -f1)
    sleep $(echo "$screennumber*3" | bc)
    width=$(echo $screen | cut -d' ' -f8)
    height=$(echo $screen | cut -d' ' -f10 | cut -d',' -f1)
    x=$(echo $width-64 | bc)
    y=$(echo $height-25 | bc)
    echo "#!/usr/bin/env bash"
    echo "#"
    echo "# Generated by aiodesktop-generator.sh"
    echo "#"
    echo "# Desktop size: $width x $height"
    echo "#"
    echo ""
    echo "#"
    echo "# Set the background color to a nice black one"
    echo "#"
    echo "xsetroot -solid black"
    echo ""
    echo "#"
    echo "# Start various utilities and place them correctly on the screen"
    echo "#"
    echo "gkrellm --geometry +$x+$yoffset &"
    echo "stalonetray --sticky --geometry +$x+$y -bg black &"
    echo ""
    for desktop in $(seq 1 $desktops); do
	if [ "$desktop" == "1" ]; then
            smallterms=$(echo "$width/($smallterm*$fontwidth-$borderwidth)" | bc)
            echo "#"
            echo "# Setting up 0-$smallterms terminals on dekstop $desktop."
            echo "#"
	    for i in $(seq 0 $smallterms); do
		x=$(echo "$smallterm*$fontwidth*$i+$borderwidth*2*$i" | bc)
		y=$yoffset
		echo "while true; do $rxvt --geometry ${smallterm}x${termheight}+${x}+${y} --title $desktop; sleep 1; done &"
	    done
	    x="0"
	    y=$(echo "$yoffset+$termheight*$fontheight+$borderwidth*2" | bc)
	    w=$(echo "($width-$pagerwidth)/$fontwidth" | bc)
	    h=$(echo "($height-$y-$borderwidth*2)/$fontheight" | bc)
	    echo "while true; do $rxvt --geometry ${w}x${h}+${x}+${y} --title $desktop; sleep 1; done &"
	else
            #
            # Skip browser desktop, otherwise setup all destops similar.
            #
            if [ "$desktop" != "2" ]; then
                terms=$(echo "$width/($bigterm*$fontwidth-$borderwidth)" | bc)
                echo ""
                echo "#"
                echo "# Setting up 0-$terms (mainly 160 columns) on desktop $desktop."
                echo "#"
	        for i in $(seq 0 $terms); do
		    if [ $(echo "$i*$bigterm*$fontwidth+$borderwidth*2*$i" | bc) -lt $width ]; then
		        x=$(echo "$bigterm*$fontwidth*$i+$borderwidth*2*$i" | bc)
		        w=$bigterm
		    else
		        x=$(echo "$smallterm*$fontwidth*$i+$borderwidth*2*$i" | bc)
		        w=$smallterm
		    fi
		    y=$yoffset
		    echo "while true; do $rxvt --geometry ${w}x${termheight}+${x}+${y} --title $desktop; sleep 1; done &"
		    y=$(echo "$yoffset+$termheight*$fontheight+$borderwidth*2" | bc)
		    h=$(echo "($height-$y-$borderwidth*2)/$fontheight" | bc)
		    echo "while true; do $rxvt --geometry ${w}x${h}+${x}+${y} --title $desktop; sleep 1; done &"
	        done
            fi
	fi
    done
done
